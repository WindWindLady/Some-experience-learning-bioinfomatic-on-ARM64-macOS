# Bayescan的奇怪编译成功？ 2024.04.08

## 事情原本没有这么顺利

因为数据分析的缘故，师姐跟我介绍了Bayescan这款软件。开始的时候，我对其的认知仅仅保留在这是个分析软件，可能会吃掉很多性能，此时我还在窃喜自己的电脑配置总算派上用场了。但是，当我在自己电脑上下载软件并解压缩准备使用时，发现这个软件需要手动编译才能继续使用。本来其实无可厚非，毕竟Bayescan也是一个发布时间比较老的软件了（2014年后再没有新版本），为了兼容、稳妥等起见，只提供源代码进行手动编译还是很正常的。因此我便开始进行调试，但自此开始了一段痛苦的经历。

**软件是从GitHub上直接通过git下载的，不是在官网上下载的zip。Bayescan和后文提到的PGDSpider可以在Windows虚拟机上使用，本文仅阐述如何在macOS上解决问题。**

刚开始编译Bayescan的时候，编译会直接报错。

`clang: error: unsupported option '-fopenmp'`

因为在2023年5月份前后，这台Mac还是很新的状态，没有安装其他的编译器，所以编译的时候本机还处在一个默认的状态，即使用clang作为默认编译器。报错后我上网搜索发现，clang已经不再对openmp这个多线程库提供支持，如果软件有这个库的应用，一定需要使用gcc编译器。所以我就安装了gcc，并且手动修改了Makefile，将'g++'改成了'g++-13'，让系统在编译的时候主动调用gcc的编译器。但是，问题又来了，即使这样修改，依然会出现下述报错。

`start.cpp:1181:57: error: reference to 'beta' is ambiguous`

根据报错内容再一次进行了查询，但是没有很明确的答案。咨询了身边同学后发现，这个错误应该是因为版本不兼容才产生的——因为代码的整体大标准在每个版本之间可能会出现较大幅度的修改，因此会出现新标准不能向下兼容的问题。当然，其中也不只是gcc的问题，macOS在编译过程中还会调用本地的SDK，我发现这个SDK也会影响到编译，因此再去下载了一些老版本的SDK，版本自OS X 10.9到macOS Big Sur 11.9都有，但是修改后仍然存在报错——

`fatal error: AvailabilityInternalLegacy.h: No such file or directory`

这个问题在2023年内尚没有解决方法（系统版本仍然处在macOS 13 Ventura中）

之后一年，我都没有管过这个问题，直到前两天（2024年4月前五天）。

## 发生了什么奇怪的事情

2024年清明节假期，我在家中继续调试这个软件。在我再一次遇到同样的报错后，我再一次上网搜索，发现了有一个类似的报错，即一样出现了`No such file or directory`，并且给出了一个解决方法

在rc文件中添加下述两句：
`export CPATH=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/`
`export LIBRARY_PATH="$LIBRARY_PATH:/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib"`

M系列芯片的Mac默认使用zsh，因此我在.zshrc文件中加入了这两句，并且仍然保留了使用macOS 11.9的SDK的语句，保存、刷新终端后重新make，发现仅有warnings，没有再出现errors，也就说明编译成功了，并且在源文件目录出现了bayescan_2.1这个文件。虽然显示为文稿，但是在终端中仍然可以激活，也就说明程序可以正常运行。之后我使用了手头的示例文件进行测试，程序也可以在 `-threads 8` 的设置下进行默认计算，用时约2h。

程序自此编译成功，并且可以正常使用了！

## 噩梦还没有结束

Bayescan是使用专有格式的软件，它需要配套PGDSpider（基于Java编写）才能正常使用。那么，PGDSpider能不能正常用呢？

很不幸，前一年它仍然无法使用。但是和Bayescan的问题被解决的同一天，它的问题也被解决了。

我在翻阅PGDSpider文档的时候注意到了其推荐的Java版本为Java 1.8，但是本机上安装的版本为OpenJDK 17。因此，抱着某种小白碰运气的心态，我不断的进行测试，发现不论什么高一点的版本，都没法正常启动PGDSpider。无奈之下只好进行降级，但是这个时候发现，从Java官方下载的Java 8，不会正常安装到正常的路径，即`/Library/Java/JavaVirtualMachines`，它会安装到`Internet Plug-in`之下，并且在.zshrc中将该路径添加为PATH后依然无效。所以我删除了所有的可见Java版本，包括OpenJDK与官网安装的Java，找到了一个版本号为 Java 8u202的安装包。

**在这里要指出的是，通过Homebrew是不能安装Java 8的，因为Homebrew上所提供的内容仅供x86架构的Mac进行安装，M系列的Mac进行安装会提示架构不兼容，因此需要手动找安装包。**

安装完成之后，我再次按照说明手册启动PGDSpider，它就可以正常运行了。不过，因为我手头的测试数据点位比较多，有8万余个，因此在进行格式转换的时候会报出内存不足的错误。此时只能关闭软件，在通过命令启动的时候多给Java虚拟机分配内存，我这里分配了16GB（即16384MB）的内存，就可以正常的转格式了，运行速度并无可感知的缓慢或有明显报错。

## 总的来说

现在这两款软件能够很好的运行在我的Mac上！



如果以后有其他问题，我还是会和这次一样，写好文档作为记录发上来，寄希望于有需要的人能够在数据的汪洋大海中找到它。
